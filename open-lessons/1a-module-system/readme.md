# Система модулей Go (Уровень Pro)
**Продолжительность:** ~1 ч 30 мин

---

## Обзор лекции

- **Цель**: Глубокое погружение в систему модулей Go  
- **Аудитория**: Профессиональные Go-разработчики / продвинутые пользователи  
- **Темы**:  
  1. Введение и контекст  
  2. Основные концепции и основы  
  3. Продвинутое управление версиями и зависимостями  
  4. Модульный прокси, контроль сумм и безопасность  
  5. Организационные/корпоративные паттерны  
  6. Практические демонстрации и отладка  
  7. Вопросы и ответы / Заключение  

---

## От GOPATH к модулям

- **Эра GOPATH**  
  - Глобальная рабочая область, сложное управление зависимостями  
  - Недетерминированные сборки, общее окружение  
- **Причины появления модулей**  
  - Локальные, изолированные определения зависимостей  
  - Воспроизводимые сборки, чёткое версионирование  
- **Ключевые преимущества**  
  - Явные файлы `go.mod` и `go.sum`  
  - Версионированные модули для надёжного управления зависимостями  

---

## Файл go.mod

- **Структура**  
  - `module <имя-модуля>`  
  - Директивы `require` для зависимостей  
  - Опционально: `replace`, `exclude`  
- **Файл go.sum**  
  - Проверка целостности загружаемых модулей  
  - Автоматически обновляется со значениями хеш-сумм  
- **Основные команды**  
  - `go mod init` – инициализирует новый модуль  
  - `go mod tidy` – чистит неиспользуемые зависимости, добавляет пропущенные  
  - `go get` – добавляет или обновляет зависимости  

---

## Семантическое версионирование (SemVer) в Go

- **Базовое версионирование**  
  - Теги вида: `v1.2.3`  
  - Patch-релизы: `v1.2.4` – исправления  
  - Minor-релизы: `v1.3.0` – новые фичи без ломающих изменений  
  - Major-релизы: `v2.0.0` – потенциально ломающее изменение  
- **Путь импорта для v2+**  
  - Необходимо включать номер мажорной версии в путь: `module/v2`  

---

## Продвинутое управление версиями и зависимостями

- **Semantic Import Versioning**  
  - Работа с мажорными версиями (`module/v2`)  
  - Рекомендации: сохранять обратную совместимость или повышать мажорную версию  
- **Транзитивные зависимости**  
  - Минимальный выбор версии (MVS)  
  - Гарантирует согласованные и повторяемые сборки  
- **replace и exclude**  
  - `replace`: локальное тестирование или временные подмены  
  - `exclude`: исключение конкретных проблемных версий  

---

## go mod vendor

- **Каталог vendor**  
  - Команда `go mod vendor` копирует зависимости локально  
  - Полезно для офлайн-сборок и закрытых сетей  
- **Плюсы и минусы**  
  - Плюсы: воспроизводимость сборок даже без доступа к прокси  
  - Минусы: может сильно разрастаться, требует обновления при смене зависимостей  

---

## Модульные прокси и контроль сумм

- **Основы прокси**  
  - Прокси по умолчанию: `proxy.golang.org`  
  - Кэширует и обеспечивает надёжность загрузки модулей  
  - Пользовательские прокси или зеркала для закрытых/корпоративных сетей  
- **База данных хеш-сумм** (`sum.golang.org`)  
  - Проверяет целостность модулей  
  - Защищает от подмены  
- **go.sum**  
  - Локальная проверка точных версий зависимостей  

---

## Приватные модули и аутентификация

- **Приватные репозитории**  
  - GitHub, GitLab и т. д., требующие авторизации  
  - Переменные окружения: `GOPRIVATE`, `GONOPROXY`  
- **Конфигурация**  
  - `go env -w GOPRIVATE=github.com/yourorg/*`  
  - Запросы к приватным репо пропускают публичные прокси  
- **Рекомендации**  
  - Безопасное хранение токенов/учётных данных  
  - Использование приватного прокси/кэша в крупных компаниях  

---

## Репозитории с несколькими модулями

- **Когда разделять**  
  - Крупные монорепозитории можно дробить по логике  
  - Чёткое разделение, независимые циклы релизов  
- **Взаимозависимости модулей**  
  - Аккуратное использование `replace` для локальной разработки  
  - Распространённый вариант: одна организация с несколькими модулями  
- **Стратегия версии**  
  - Теги в Git, соответствующие версиям модулей  
  - Автоматизация релизов в CI/CD (например, GitHub Actions)  

---

## Организационные паттерны

- **Корпоративная стратегия версионирования**  
  - Синхронизация веток Git с мажорными релизами  
  - Теги: `v1.0.0`, `v1.1.0`, `v2.0.0` и т. д.  
- **Внутренние прокси**  
  - Развёртывание собственного модульного прокси для внутренних библиотек  
  - Ускорение сборок и повышение надёжности  
- **Аудиты зависимостей**  
  - Регулярная проверка уязвимостей и устаревших версий  

---

## Практические демонстрации

1. **Инициализация модуля**  
```bash
go mod init github.com/username/demo
go get github.com/pkg/errors
go mod tidy
```

бновление/понижение версий зависимостей
```bash
go get github.com/pkg/errors@v0.9.1
go get github.com/pkg/errors@v0.8.0
```

Использование replace
```bash
replace github.com/pkg/errors => ../local/errors
```

go mod vendor
```bash
go mod vendor
ls vendor/
```
---

## Отладка распространённых проблем

- **Конфликты версий**  
  - Изучайте `go.mod` и `go.sum` на предмет несовпадений  
  - Используйте `go mod why` / `go mod graph` для поиска конфликтов  
- **Доступ к приватным репозиториям**  
  - Проверьте переменные окружения и учётные данные  
- **Несоответствие мажорной версии**  
  - `module/v2` случайно импортируется как `module`?  
  - Убедитесь в корректном пути импорта в `go.mod` и исходном коде  

---

## Вопросы и ответы

- **Типичные ловушки**  
  - Редко обновляемые `go.mod` / `go.sum`  
  - Чрезмерное использование `replace`  
  - Отсутствие перехода на мажорные версии при ломающих изменениях  
- **Свободная дискуссия**  
  - Вопросы аудитории  
  - Реальные кейсы и опыт  

---

## Основные выводы и ресурсы

- **Главные выводы**  
  - Модули дают воспроизводимые сборки и явное управление зависимостями  
  - Семантическое версионирование – ключ к стабильным релизам  
  - Прокси, контроль сумм и vendor нужно использовать по ситуации  
- **Дополнительные материалы**  
  - [Официальная документация по модулям Go](https://golang.org/doc/modules)  
  - [Go Blog: Using Go Modules](https://blog.golang.org/using-go-modules)  
  - Сообщество, блоги и продвинутые инструменты  
https://go.dev/wiki/Modules#semantic-import-versioning
https://go.dev/ref/mod#minimal-version-selection
---